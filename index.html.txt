<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecci√≥n de Necesidades de Capacitaci√≥n 2026 (DNC) - Soft Skills</title>
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      // Alias robusto para jsPDF para asegurar compatibilidad
      window.jsPDF = window.jspdf && window.jspdf.jsPDF;
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 2rem;
            transition: all 0.3s ease-in-out;
        }
        #submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #9ca3af;
        }
        .loader, .spinner {
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #fff;
            width: 20px;
            height: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar { transition: width 0.3s ease-in-out; }
        .incomplete-card { border: 1px solid #d1d5db; }
        .completed-card { border: 1px solid #22c55e; }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto">
        <div class="card">
            <!-- HEADER -->
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <div class="text-center sm:text-left">
                    <h1 class="text-3xl font-bold text-gray-900">Plataforma DNC 2026</h1>
                    <p class="mt-2 text-gray-600">Herramienta para la Detecci√≥n de Necesidades de Capacitaci√≥n.</p>
                </div>
                <!-- Logo con fallback -->
                <img src="https://intranet.learning-campus.siemens.com/_images/newton/siemens-logo-newton.png" alt="Logo de Siemens" class="h-10 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x50/009999/FFFFFF?text=Siemens';">
            </header>

            <!-- Estado de Carga -->
            <section id="loading-state" class="text-center py-10">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-600">Cargando cat√°logo de cursos...</p>
                <p id="loading-error" class="text-red-500 mt-2 font-medium hidden"></p>
            </section>

            <!-- SECCI√ìN 1: LOGIN SUPERVISOR -->
            <section id="supervisor-login" class="hidden mb-8">
                
                <!-- INSTRUCCIONES -->
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg mb-8" role="alert">
                    <h3 class="font-bold text-lg mb-2">Siemens ‚Äî Detecci√≥n de Necesidades de Capacitaci√≥n (DNC) 2026</h3>
                    <p class="mb-2 text-sm">
                        <strong>Estimados Managers,</strong><br>
                        De cara a la planificaci√≥n del 2026, iniciamos el proceso de Detecci√≥n de Necesidades de Capacitaci√≥n (DNC). El objetivo es identificar competencias cr√≠ticas, cerrar brechas y potenciar el desarrollo de sus equipos.
                    </p>
                    <p class="mb-2 text-sm">
                        Este a√±o, ponemos un foco especial en las <a href="https://siemensworld.dc.siemens.com/2025/11/21/grow-and-thrive-in-work-and-life-foundational-skills/" target="_blank" class="text-blue-600 underline hover:text-blue-800 font-bold">Foundational Skills de Siemens</a> (Pensamiento Cr√≠tico, Resiliencia, Colaboraci√≥n, Creatividad, Inteligencia Emocional y Comunicaci√≥n), incorporando tambi√©n competencias clave en <strong>Tech & Data / IA</strong>. Estas habilidades son nuestra ventaja competitiva para navegar los cambios tecnol√≥gicos y de mercado.
                    </p>
                    <div class="mb-2 text-sm">
                        <strong>Instrucciones:</strong>
                        <ul class="list-disc list-inside ml-2 mt-1 space-y-1">
                            <li>Aborda este tema durante las Growth Talks con cada integrante de tu equipo.</li>
                            <li>Identifica las brechas y selecciona las capacitaciones que fortalezcan sus Foundational Skills y capacidades digitales.</li>
                            <li><strong>Importante:</strong> Esta oferta es complementaria al cat√°logo t√©cnico disponible en My Learning World.</li>
                            <li><strong>Al ingresar:</strong> Selecciona <strong>3 opciones de capacitaci√≥n distintas</strong> para cada colaborador. Tambi√©n podr√°s sugerir otras formaciones espec√≠ficas y agregar comentarios adicionales en el apartado de observaciones.</li>
                        </ul>
                    </div>
                    <p class="mt-3 text-sm font-semibold">
                        Periodo de respuesta: Diciembre 2025.
                    </p>
                </div>

                <h2 class="text-xl font-semibold mb-4 text-center border-t pt-8">Paso 1: Identificaci√≥n del Manager</h2>
                <div class="text-center mb-6">
                     <button onclick="showCoursesModal()" class="bg-white text-blue-600 font-semibold py-2 px-4 border border-blue-600 rounded-lg hover:bg-blue-50 transition-colors">
                        Ver Cat√°logo de Cursos
                     </button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
                    <input type="text" id="supervisor-rut" placeholder="Ingrese su RUT (ej: 12.345.678-9)..." class="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" oninput="formatAndValidateRut(this)">
                    <button id="search-button" onclick="findEmployees()" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center gap-2">
                        <span id="search-button-text">Ingresar</span>
                    </button>
                </div>
                 <div id="rut-validation-message" class="text-red-500 text-center text-sm mt-2 font-medium"></div>
                <div id="error-message" class="text-red-500 text-center mt-4 font-medium"></div>
            </section>

            <!-- SECCI√ìN 2: LISTA DE EMPLEADOS Y ASIGNACI√ìN -->
            <section id="employee-list-section" class="hidden">
                <div class="mb-4">
                    <button onclick="goBackToLogin()" class="text-sm text-blue-600 hover:underline">&larr; Cambiar de supervisor</button>
                </div>
                <h2 class="text-xl font-semibold mb-2 text-center">Paso 2: Asignar Cursos de Soft Skills</h2>
                <p id="supervisor-info" class="text-center text-gray-600 mb-6"></p>
                
                <!-- Barra de Progreso -->
                <div id="progress-container" class="mb-6">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-blue-700">Progreso de la Evaluaci√≥n</span>
                        <span id="progress-text" class="text-sm font-medium text-blue-700">0 / 0 Completados</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mt-6 border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 text-left">Colaboradores bajo tu supervisi√≥n:</h3>
                    <div id="employee-list" class="space-y-6">
                        <!-- Los empleados se cargan aqu√≠ v√≠a JS -->
                    </div>
                </div>

                <!-- Preferencias Generales -->
                <div class="mt-8 border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Preferencias Generales de Capacitaci√≥n</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg">
                        <!-- Modalidad -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Modalidad de Entrega</label>
                            <div class="flex flex-col gap-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio" name="modalidad" value="Presencial" onchange="handleModalidadChange(this.value); saveProgress();">
                                    <span class="ml-2">Presencial</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio" name="modalidad" value="Virtual" onchange="handleModalidadChange(this.value); saveProgress();">
                                    <span class="ml-2">Virtual</span>
                                </label>
                            </div>
                        </div>
                        <!-- Sincron√≠a -->
                        <div id="sincronia-section" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Formato Virtual</label>
                            <div class="flex flex-col gap-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio" name="sincronia" value="Sincr√≥nica" onchange="saveProgress()">
                                    <span class="ml-2">Sincr√≥nica (en vivo)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio" name="sincronia" value="Asincr√≥nica" onchange="saveProgress()">
                                    <span class="ml-2">Asincr√≥nica (a tu ritmo)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" class="form-radio" name="sincronia" value="Blended" onchange="saveProgress()">
                                    <span class="ml-2">Blended (mixto)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="mt-8 border-t pt-6">
                    <label for="general-observations" class="block text-lg font-semibold text-gray-800 mb-2">Observaciones Generales (Opcional)</label>
                    <p class="text-sm text-gray-600 mb-2">Use este espacio si necesita sugerir un curso que no est√° en la lista o a√±adir comentarios generales.</p>
                    <textarea id="general-observations" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="Escriba aqu√≠ sus comentarios..." oninput="saveProgress()"></textarea>
                </div>

                <div class="mt-8 text-center">
                    <button id="submit-button" onclick="showConfirmationModal()" class="w-full md:w-1/2 bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors text-lg shadow-lg">
                        <span id="button-text">Finalizar y Enviar Datos</span>
                        <div id="button-loader" class="hidden mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div>
                    </button>
                </div>
            </section>
            
            <!-- SECCI√ìN 3: √âXITO -->
            <section id="success-view" class="hidden text-center py-10">
                 <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="mt-4 text-2xl font-bold text-gray-900">¬°Evaluaci√≥n Enviada!</h2>
                <p id="success-message" class="mt-2 text-gray-600">Muchas gracias por su participaci√≥n. Sus respuestas han sido guardadas correctamente.</p>
                <p class="mt-4 text-sm text-gray-500 max-w-xl mx-auto">El equipo de Learning & Growth consolidar√° los resultados. Los planes se comunicar√°n oficialmente durante el primer trimestre de 2026.</p>
                <div class="mt-6 flex flex-col items-center gap-4">
                     <button onclick="goBackToLogin(true)" class="w-full md:w-1/2 bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                        Evaluar otro equipo
                     </button>
                </div>
            </section>
        </div>

        <!-- FOOTER -->
        <footer class="text-center mt-8 text-gray-500 text-xs border-t pt-4">
            <p class="font-semibold">Elaborado por: David Linares</p>
            <p>GP Strategies | Learning Administrator</p>
            <p>External Service Provider at Siemens AG</p>
            <p>Learning & Growth Sur Am√©rica</p>
            <p class="mt-4 text-gray-400">&copy; 2025 Herramienta DNC. Todos los derechos reservados.</p>
        </footer>
    </div>
    
    <!-- TOAST DE GUARDADO -->
    <div id="save-toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        <span class="font-semibold">‚úì Progreso guardado</span>
    </div>

    <!-- Modal Cat√°logo -->
    <div id="courses-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl transform scale-95 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Cat√°logo de Cursos</h3>
                <button onclick="hideCoursesModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-4">
                <input type="text" id="course-search-input" placeholder="Buscar curso, competencia o descripci√≥n..." class="w-full p-2 border border-gray-300 rounded-md" oninput="filterCourses()">
            </div>
            <div id="courses-modal-list" class="overflow-y-auto pr-4"></div>
             <div class="mt-6 flex justify-end gap-4">
                <button onclick="exportCoursesPDF()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Exportar a PDF</button>
                <button onclick="hideCoursesModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Confirmaci√≥n -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95">
            <h3 class="text-xl font-bold mb-4">Confirmar Env√≠o</h3>
            <p class="text-gray-600 mb-6">¬øEst√° seguro de que desea enviar las evaluaciones? Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-end gap-4">
                <button onclick="hideConfirmationModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button onclick="sendDataToSheet()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Confirmar y Enviar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Restaurar -->
    <div id="restore-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95">
            <h3 class="text-xl font-bold mb-4">Progreso Encontrado</h3>
            <p class="text-gray-600 mb-6">Hemos detectado una sesi√≥n no finalizada para este equipo. ¬øDesea restaurar su progreso anterior?</p>
            <div class="flex justify-end gap-4">
                <button onclick="startNewSession()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Empezar de Nuevo</button>
                <button onclick="restoreProgress()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">S√≠, Restaurar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        // URL segura de tu despliegue final
        const googleAppScriptUrl = "https://script.google.com/macros/s/AKfycbxlseiRY0nPl6c2rngZigMBrrv6MOS7ilXMRcLIDCDbKxOwr-vbaNb21N7WeTeAntTU/exec";
        
        // --- VARIABLES GLOBALES ---
        let supervisorGlobal = null;
        let allEmployees = []; 
        let allCourses = [];
        let saveToastTimeout;
        let lastSubmissionData = null;

        document.addEventListener('DOMContentLoaded', fetchInitialData);

        function normalizeCourses(input) {
            try {
                const raw = typeof input === 'string' ? JSON.parse(input) : input;
                const arr = Array.isArray(raw) ? raw : (raw && typeof raw === 'object' ? Object.values(raw) : []);

                return arr.map((c) => {
                    // Mapeo defensivo
                    if (typeof c === 'string') return { nombre: c, competencia: 'General', descripcion: '' };
                    return {
                        nombre: c.nombre || c.name || c.curso || c.titulo || '',
                        competencia: c.competencia || c.skill || c.categoria || 'General',
                        descripcion: c.descripcion || c.description || c.detalle || ''
                    };
                }).filter((c) => c && c.nombre);
            } catch (e) {
                console.warn('Error parseando cursos:', e);
                return [];
            }
        }

        // CARGA INICIAL: Solo cat√°logo
        function fetchInitialData() {
            if (googleAppScriptUrl.includes('¬°Pega aqu√≠')) {
                showConfigError();
                return;
            }

            fetch(googleAppScriptUrl + '?action=getCatalog')
                .then((response) => (response.ok ? response.json() : Promise.reject(`Error red: ${response.status}`)))
                .then((data) => {
                    if (data.status === 'error') throw new Error(data.message || 'Error remoto');
                    
                    allCourses = normalizeCourses(data.courses);

                    if (!allCourses.length) console.warn('Cat√°logo vac√≠o.');

                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('supervisor-login').classList.remove('hidden');
                })
                .catch((error) => handleNetworkError(error));
        }

        // LOGIN: Consulta segura al servidor
        function findEmployees() {
            const rutInputWithDots = document.getElementById('supervisor-rut').value;
            const rutInputClean = rutInputWithDots.replace(/\./g, '').trim(); 
            const rutValidationMsg = document.getElementById('rut-validation-message');
            
            if (!checkRut(rutInputClean)) {
                rutValidationMsg.textContent = 'El RUT ingresado no es v√°lido.';
                return;
            }
            rutValidationMsg.textContent = '';
            
            const searchButton = document.getElementById('search-button');
            const searchButtonText = document.getElementById('search-button-text');
            const originalButtonText = searchButtonText.textContent;
            searchButtonText.textContent = 'Buscando...';
            searchButton.disabled = true;
            searchButton.insertAdjacentHTML('beforeend', '<div class="spinner"></div>');

            fetch(googleAppScriptUrl + '?action=login&rut=' + encodeURIComponent(rutInputClean))
                .then(response => response.json())
                .then(data => {
                     const errorMessage = document.getElementById('error-message');
                     errorMessage.innerHTML = '';
                     
                     if (data.status === 'error' || !data.supervisor) {
                         if (data.message && (data.message.includes('No se encontr√≥') || data.message.includes('Supervisor no encontrado'))) {
                             errorMessage.innerHTML = 'RUT no encontrado. Ante cualquier duda comun√≠cate con David Linares por correo o Teams: <a href="mailto:david.linares.ext@siemens.com" class="text-blue-600 underline">david.linares.ext@siemens.com</a>.';
                         } else {
                             errorMessage.textContent = 'Error: ' + (data.message || 'Error desconocido');
                         }
                     } else {
                         supervisorGlobal = data.supervisor;
                         allEmployees = data.employees;

                         if (!allEmployees || allEmployees.length === 0) {
                             errorMessage.textContent = 'No se encontraron colaboradores a su cargo.';
                         } else {
                             const savedProgress = localStorage.getItem('dnc-progress-' + supervisorGlobal.RUT);
                             if (savedProgress) {
                                 showRestoreModal();
                             } else {
                                 startNewSession(true);
                             }
                         }
                     }
                })
                .catch(error => {
                    console.error("Error en login:", error);
                    document.getElementById('error-message').textContent = 'Error de conexi√≥n. Intente nuevamente.';
                })
                .finally(() => {
                    searchButtonText.textContent = originalButtonText;
                    searchButton.disabled = false;
                    searchButton.querySelector('.spinner')?.remove();
                });
        }
        
        function showConfigError() {
            const loadingError = document.getElementById('loading-error');
            loadingError.textContent = 'Error de Configuraci√≥n: La URL del script no ha sido actualizada.';
            loadingError.classList.remove('hidden');
            document.getElementById('loading-state').querySelector('p').classList.add('hidden');
            document.getElementById('loading-state').querySelector('.loader').classList.add('hidden');
        }

        function handleNetworkError(error) {
            console.error('Error inicial:', error);
            const loadingError = document.getElementById('loading-error');
            const msg = error && error.message ? error.message : String(error);
            loadingError.textContent = `Error al conectar: ${msg}. Verifique la conexi√≥n.`;
            loadingError.classList.remove('hidden');
        }

        function formatAndValidateRut(input) {
            let rut = input.value.replace(/[^0-9kK]/g, '');
            const rutValidationMsg = document.getElementById('rut-validation-message');
            rutValidationMsg.textContent = '';
            let result = '';
            let rutCleanForValidation = '';

            if (rut.length > 1) {
                const dv = rut.slice(-1);
                const body = rut.slice(0, -1);
                rutCleanForValidation = body + '-' + dv;
                result = new Intl.NumberFormat('es-CL').format(body) + '-' + dv.toUpperCase();
                if (!checkRut(rutCleanForValidation)) {
                    rutValidationMsg.textContent = 'El RUT ingresado no es v√°lido.';
                }
            } else {
                result = rut;
            }
            input.value = result;
        }

        function checkRut(rut) {
            rut = rut.replace(/\./g, '').toUpperCase();
            if (!/^[0-9]+-[0-9kK]{1}$/.test(rut)) return false;
            const [body, dv] = rut.split('-');
            let sum = 0;
            let multiple = 2;
            for (let i = body.length - 1; i >= 0; i--) {
                sum += multiple * body.charAt(i);
                multiple = multiple < 7 ? multiple + 1 : 2;
            }
            const dvExpected = 11 - (sum % 11);
            const dvFinal = (dvExpected == 11) ? '0' : (dvExpected == 10) ? 'K' : dvExpected.toString();
            return dvFinal == dv;
        }


        function displayEmployees(employees) {
            const container = document.getElementById('employee-list');
            container.innerHTML = '';
            
            employees.forEach(employee => {
                const employeeCard = document.createElement('div');
                employeeCard.className = 'p-5 bg-gray-50 border rounded-lg incomplete-card';
                employeeCard.setAttribute('data-rut', employee.RUT);
                employeeCard.setAttribute('data-nombre', employee['Nombre completo']);
                employeeCard.setAttribute('data-email', employee.Email);
                
                const courseOptions = `<option value="">-- Seleccionar curso --</option>` + 
                                      allCourses.map(courseObj => `<option value="${courseObj.nombre}" title="${courseObj.descripcion}">${courseObj.nombre}</option>`).join('');

                const empresaBadge = employee.Empresa 
                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-600 border border-gray-300 mt-1">
                         üè¢ ${employee.Empresa}
                       </span>` 
                    : '';

                employeeCard.innerHTML = `
                    <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-4">
                        <div class="flex-shrink-0 lg:w-1/3">
                            <h3 class="text-lg font-bold text-gray-800">${employee['Nombre completo']}</h3>
                            <p class="text-sm text-gray-500 mb-1">${employee.Cargo}</p>
                            ${empresaBadge}
                        </div>
                        <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad 1</label>
                                <select class="course-select p-2 border border-gray-300 rounded-md w-full">${courseOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad 2</label>
                                <select class="course-select p-2 border border-gray-300 rounded-md w-full">${courseOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad 3</label>
                                <select class="course-select p-2 border border-gray-300 rounded-md w-full">${courseOptions}</select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observaci√≥n Particular (Adicional):</label>
                        <textarea class="justification-text w-full p-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="Comentarios espec√≠ficos o sugerencias de otros cursos..."></textarea>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="no-courses-checkbox form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="ml-2 text-sm text-gray-700">Marcar si este colaborador no requiere cursos en este ciclo.</span>
                        </label>
                    </div>`;
                container.appendChild(employeeCard);
            });
            
            // Logic for interactions (enable/disable, progress check)
            container.querySelectorAll('.p-5').forEach(card => {
                const selects = card.querySelectorAll('.course-select');
                const justification = card.querySelector('.justification-text');
                const noCoursesCheckbox = card.querySelector('.no-courses-checkbox');

                const handleInteraction = () => {
                    const selectedValues = Array.from(selects).map(s => s.value).filter(Boolean);
                    selects.forEach(s => {
                        Array.from(s.options).forEach(option => {
                            option.disabled = selectedValues.includes(option.value) && s.value !== option.value;
                        });
                    });
                    updateProgress();
                    saveProgress();
                };

                selects.forEach(select => select.addEventListener('change', handleInteraction));
                justification.addEventListener('input', saveProgress);

                noCoursesCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    selects.forEach(s => {
                        if (isChecked) {
                            s.value = '';
                            s.disabled = true;
                        } else {
                            s.disabled = false;
                        }
                    });
                    handleInteraction();
                });
            });
            updateProgress();
        }

        function updateProgress() {
            const allCards = document.querySelectorAll('#employee-list > div');
            const totalEmployees = allCards.length;
            let completedEmployees = 0;

            allCards.forEach(card => {
                const selects = card.querySelectorAll('.course-select');
                const noCoursesCheckbox = card.querySelector('.no-courses-checkbox');
                
                const isComplete = Array.from(selects).some(s => s.value !== "") || noCoursesCheckbox.checked;

                if (isComplete) {
                    completedEmployees++;
                    card.classList.remove('incomplete-card');
                    card.classList.add('completed-card');
                } else {
                    card.classList.add('incomplete-card');
                    card.classList.remove('completed-card');
                }
            });

            const percentage = totalEmployees > 0 ? (completedEmployees / totalEmployees) * 100 : 0;
            document.getElementById('progress-text').textContent = `${completedEmployees} / ${totalEmployees} Completados`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            const submitButton = document.getElementById('submit-button');
            if (completedEmployees === totalEmployees && totalEmployees > 0) {
                submitButton.disabled = false;
                submitButton.title = "Todo listo para enviar.";
            } else {
                submitButton.disabled = true;
                submitButton.title = "Por favor, eval√∫e a cada colaborador.";
            }
        }

        function goBackToLogin(fromSuccess = false) {
            document.getElementById('employee-list-section').classList.add('hidden');
            document.getElementById('supervisor-login').classList.remove('hidden');
            if (fromSuccess) document.getElementById('success-view').classList.add('hidden');
            document.getElementById('supervisor-rut').value = '';
            document.getElementById('error-message').textContent = '';
            supervisorGlobal = null;
        }
        
        function showConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function hideConfirmationModal(isRestore = false) {
            const modalId = isRestore ? 'restore-modal' : 'confirmation-modal';
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        function sendDataToSheet() {
            hideConfirmationModal();
            const button = document.getElementById('submit-button');
            const successView = document.getElementById('success-view');

            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto"></div>';
            
            const evaluations = [];
            document.querySelectorAll('#employee-list > div').forEach(card => {
                const selects = card.querySelectorAll('.course-select');
                const justification = card.querySelector('.justification-text').value;
                const noCourses = card.querySelector('.no-courses-checkbox').checked;
                evaluations.push({
                    rut: card.dataset.rut,
                    nombre: card.dataset.nombre,
                    email: card.dataset.email,
                    curso1: selects[0].value,
                    curso2: selects[1].value,
                    curso3: selects[2].value,
                    justificacion: justification,
                    noCourses: noCourses
                });
            });
            
            const generalObservations = document.getElementById('general-observations').value;
            const modalidad = document.querySelector('input[name="modalidad"]:checked')?.value || '';
            const sincronia = document.querySelector('input[name="sincronia"]:checked')?.value || '';

            const payload = {
                supervisor: {
                    rut: supervisorGlobal.RUT,
                    email: supervisorGlobal.Email,
                    nombre: supervisorGlobal['Nombre completo'],
                    observaciones: generalObservations,
                    modalidad: modalidad,
                    sincronia: (modalidad === 'Virtual') ? sincronia : ''
                },
                evaluaciones: evaluations
            };
            
            lastSubmissionData = payload;

            fetch(googleAppScriptUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload),
            })
            .then(response => response.json())
            .then(data => {
                if(data.status !== "success") throw new Error(data.message || 'Error desconocido.');
                
                localStorage.removeItem('dnc-progress-' + supervisorGlobal.RUT);
                document.getElementById('employee-list-section').classList.add('hidden');
                successView.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error enviando:', error);
                alert(`Error al enviar: ${error.message}.`);
                button.disabled = false;
                button.innerHTML = '<span>Finalizar y Enviar Datos</span>';
            });
        }
        
        function handleModalidadChange(value) {
            const sincroniaSection = document.getElementById('sincronia-section');
            if (value === 'Virtual') {
                sincroniaSection.classList.remove('hidden');
            } else {
                sincroniaSection.classList.add('hidden');
                document.querySelectorAll('input[name="sincronia"]').forEach(radio => radio.checked = false);
            }
        }

        function saveProgress() {
            if (!supervisorGlobal) return;
            const progressData = {
                evaluations: {},
                generalObservations: document.getElementById('general-observations').value,
                modalidad: document.querySelector('input[name="modalidad"]:checked')?.value || '',
                sincronia: document.querySelector('input[name="sincronia"]:checked')?.value || ''
            };
            document.querySelectorAll('#employee-list > div').forEach(card => {
                const rut = card.dataset.rut;
                const selects = card.querySelectorAll('.course-select');
                const justificationText = card.querySelector('.justification-text');
                const noCoursesCheckbox = card.querySelector('.no-courses-checkbox');

                progressData.evaluations[rut] = {
                    curso1: selects.length > 0 ? selects[0].value : '',
                    curso2: selects.length > 1 ? selects[1].value : '',
                    curso3: selects.length > 2 ? selects[2].value : '',
                    justificacion: justificationText ? justificationText.value : '',
                    noCourses: noCoursesCheckbox ? noCoursesCheckbox.checked : false
                };
            });
            localStorage.setItem('dnc-progress-' + supervisorGlobal.RUT, JSON.stringify(progressData));
            showSaveToast();
        }

        function restoreProgress() {
            hideConfirmationModal(true);
            const savedProgress = JSON.parse(localStorage.getItem('dnc-progress-' + supervisorGlobal.RUT));
            if (!savedProgress) return;
            
            startNewSession(true, () => {
                document.querySelectorAll('#employee-list > div').forEach(card => {
                    const rut = card.dataset.rut;
                    const savedEval = savedProgress.evaluations[rut];
                    if (savedEval) {
                        const selects = card.querySelectorAll('.course-select');
                        const noCoursesCheckbox = card.querySelector('.no-courses-checkbox');

                        if (savedEval.noCourses) {
                            noCoursesCheckbox.checked = true;
                            selects.forEach(s => s.disabled = true);
                        } else {
                            selects[0].value = savedEval.curso1;
                            selects[1].value = savedEval.curso2;
                            selects[2].value = savedEval.curso3;
                        }
                        card.querySelector('.justification-text').value = savedEval.justificacion;
                        noCoursesCheckbox.dispatchEvent(new Event('change'));
                    }
                });
                document.getElementById('general-observations').value = savedProgress.generalObservations || '';
                
                if (savedProgress.modalidad) {
                    document.querySelector(`input[name="modalidad"][value="${savedProgress.modalidad}"]`).checked = true;
                    handleModalidadChange(savedProgress.modalidad);
                }
                if (savedProgress.sincronia) {
                    document.querySelector(`input[name="sincronia"][value="${savedProgress.sincronia}"]`).checked = true;
                }
                updateProgress();
            });
        }

        function startNewSession(skipModal = false, callback) {
            if (!skipModal) hideConfirmationModal(true);
            localStorage.removeItem('dnc-progress-' + supervisorGlobal.RUT);
            
            // Ya no filtramos localmente, usamos lo que trajo el servidor
            document.getElementById('supervisor-info').innerHTML = `Evaluando como: <span class="font-semibold">${supervisorGlobal['Nombre completo']}</span>`;
            displayEmployees(allEmployees);

            if (typeof callback === 'function') callback();

            document.getElementById('employee-list-section').classList.remove('hidden');
            document.getElementById('supervisor-login').classList.add('hidden');
        }
        
        function showRestoreModal() {
            const modal = document.getElementById('restore-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function showCoursesModal() {
            const modal = document.getElementById('courses-modal');
            document.getElementById('course-search-input').value = '';
            filterCourses();
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }
        
        function filterCourses() {
            const input = document.getElementById('course-search-input');
            const filter = (input.value || '').toUpperCase();
            const listContainer = document.getElementById('courses-modal-list');
            listContainer.innerHTML = '';

            if (!Array.isArray(allCourses) || allCourses.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">No hay cursos disponibles para mostrar.</p>';
                return;
            }

            const filteredCourses = allCourses.filter(courseObj => {
                const textToSearch = `${courseObj.nombre || ''} ${courseObj.competencia || ''} ${courseObj.descripcion || ''}`.toUpperCase();
                return textToSearch.includes(filter);
            });

            if (filteredCourses.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">No se encontraron cursos que coincidan con la b√∫squeda.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            const thead = `<thead><tr class="border-b"><th class="py-2 pr-2 font-semibold">Cursos</th><th class="py-2 px-2 font-semibold">Skill</th><th class="py-2 pl-2 font-semibold">Descripci√≥n</th></tr></thead>`;
            const tbody = document.createElement('tbody');

            filteredCourses.forEach(courseObj => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="py-2 pr-2 font-medium">${courseObj.nombre || ''}</td>
                    <td class="py-2 px-2 text-gray-600">${courseObj.competencia || 'General'}</td>
                    <td class="py-2 pl-2 text-gray-500">${courseObj.descripcion || ''}</td>
                `;
                tbody.appendChild(tr);
            });
            
            table.innerHTML = thead;
            table.appendChild(tbody);
            listContainer.appendChild(table);
        }

        function hideCoursesModal() {
            const modal = document.getElementById('courses-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        function exportCoursesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont("helvetica", "normal");
            const today = new Date().toLocaleDateString('es-CL');
            let y = 20;

            const addHeader = (docInstance) => {
                docInstance.setFont("helvetica", "bold");
                docInstance.setFontSize(16);
                docInstance.setTextColor(0, 153, 153);
                docInstance.text("Cat√°logo de Cursos - Soft Skills 2026", 105, 15, { align: 'center' });
                
                docInstance.setFont("helvetica", "normal");
                docInstance.setFontSize(9);
                docInstance.setTextColor(100);
                docInstance.text(`Fecha de Emisi√≥n: ${today}`, 196, 22, { align: 'right'});
                
                docInstance.setDrawColor(200);
                docInstance.setLineWidth(0.5);
                docInstance.line(14, 25, 196, 25);
            };

            const addFooter = (docInstance) => {
                const pageCount = docInstance.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    docInstance.setPage(i);
                    docInstance.setFont("helvetica", "normal");
                    docInstance.setFontSize(8);
                    docInstance.setTextColor(128);
                    const footerText = `Elaborado por: David Linares | GP Strategies`;
                    docInstance.text(footerText, 14, 287);
                    docInstance.text(`P√°gina ${i} de ${pageCount}`, 196, 287, { align: 'right' });
                }
            };
            
            addHeader(doc);
            y = 35;

            allCourses.forEach(courseObj => {
                const nameText = `‚Ä¢ ${courseObj.nombre}`;
                const skillText = `   Skill: ${courseObj.competencia || 'General'}`;
                const descText = `   ${courseObj.descripcion || 'Sin descripci√≥n disponible.'}`;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                const nameLines = doc.splitTextToSize(nameText, 180);
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                const skillLines = doc.splitTextToSize(skillText, 180);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                const descLines = doc.splitTextToSize(descText, 170);

                const blockHeight = (nameLines.length * 6) + (skillLines.length * 5) + (descLines.length * 5) + 8;

                if (y + blockHeight > 280) {
                    doc.addPage();
                    addHeader(doc);
                    y = 35;
                }

                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.setTextColor(0); 
                doc.text(nameLines, 14, y);
                y += (nameLines.length * 6);

                doc.setFont("helvetica", "bold"); 
                doc.setFontSize(10);
                doc.setTextColor(80); 
                doc.text(skillLines, 14, y);
                y += (skillLines.length * 5);

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(100); 
                doc.text(descLines, 14, y);
                y += (descLines.length * 5) + 4;
            });

            addFooter(doc);
            doc.save('Catalogo_Cursos_DNC_Siemens_2026.pdf');
        }
        
        function showSaveToast() {
            const toast = document.getElementById('save-toast');
            toast.classList.remove('opacity-0');
            clearTimeout(saveToastTimeout);
            saveToastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000); 
        }

    </script>
</body>
</html>